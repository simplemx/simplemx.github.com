部门从5月开始就有接近差不多一半的人在折腾一个性能问题，但是一直到现在都没最终解决。

这里记录一下这个问题。

首先出问题的是终端系统，现在商城里到处可见商家摆在外面的终端机，这个系统就是运行在终端机上的web系统。当然业务关系比一般商家的终端系统复杂并且办理量在三线地市十分巨大。

背景是这样的，去年该省份进行了一次全系统的升级，所谓升级，不过是庞大的系统里很多东西都重新设计重新开发，所以其实风险很大，而且换个角度来说可能还是倒退。不过人家厂家有钱，给得起折腾。

所以原来运行得好好的终端系统全部扔掉重做。

最要命的事情是，我们部门负责的这些产品最好的情况上只是调整下和后台接口就可以了，前台优化下界面就满足了。但是却因为政治原因，被逼全量产品推翻，重新做，而且重做是另外一个部门主导，我们根本没有对产品的决定权。

这里简单描述下这个部门。

1. 这个部门的人各方面水平都很差劲，无论是研发还是管理，毕竟有经验的人不多。
2. 混杂大量三四流院校实习生，尤其是负责这个终端产品的人只有2个人是有经验的，其他全是实习生，这些实习生的水平可以差到连java静态类方法都不知道怎么调用。当然，态度才是主要的，但是显然，他们天天刷微博看网易，根本就没人有时间理睬他们，说了也是白说，培训实习生什么的在上线期间简直就是笑话。这些实习生在项目里带来的只有负面因素，人数庞大，战斗力为负。
3. 该部门模式是负责产品上线，上线后拍拍屁股走人，留现场的帮他们擦屁股，他们负责的省份都是这样的模式，但是这个省份却是需要我们产品部的肩负很大的维护责任。
4. 该部门使用的所谓技术是个老框架，适合做管理系统，根本不适合做前台。他们部门的习惯是所有产品每个产品一个工程，重用性基本为零，毕竟他们人多，而且比较适合他们去一个地方然后让现场擦屁股的情况，但是我们部门人少，多个产品但其实逻辑基本相似的所以我们是多产品放同个工程，页面部分再分开，业务逻辑共用。

当时这个终端产品的选型是这样的：

自然是一个独立的工程，跟其他产品一点瓜葛都没有，所以到处都是重新开发。

老系统使用的是Flex。但是开始新终端因为开始鼓吹的原因，所以想使用HTML5，其实也就是使用localstorge，所以呢，最后采用web开发，因为当时需要定制浏览器，所以需要找内核，结果找了个两年多钱的Firefox3的内核，然后web样式做出来之后，想升级Firefox却因为样式乱了，他们就没升级了，就一直沿用Firefox3来继续开发了。

有经验的组长觉得局部刷新会更有效率，所以每个页面都是先返回一个页面框架然后一堆Ajax去请求各个部分的内容的。然后呢，切换页面的时候竟然是普通的页面跳转，不是Ajax了。所以每个页面请求都是首先一个页面框架然后一堆Ajax了。

最后的选型就是Firefox3+Java Web，页面Ajax局部内容。

因为实习生太多，很多都是ctrl-c/ctrl-y，了解终端系统的人太少，结果最后出来的终端系统的代码简直是噩梦。

为什么说是噩梦呢，一点规范都没有，各有各的名字取法，每个地方都是乱七八糟的文件，要找某个模块的文件，你就等着脑细胞死亡好了，代码注释清晰什么的就更别提了。

好吧，背景扯太多了。

该省份的终端机性能其实很差，大多数还是和那些三四年前的电脑差不多，512M内存咯，但是却有不少只有256M内存的机子，而要知道这种机子上需要跑赛门铁克，跑我们的Firefox，跑win系统，跑这样那样的硬件相关软件，可见这样的硬件下其实留给我们的系统可用的资源真的不多。

在这样的硬件条件下最恰当的浏览器其实就是IE6。毕竟，IE6占资源真的很少。

可以升级硬件固然好，但是，中国的情况，你懂得。

而原来老终端使用Flex的情况是已经经历过验证的，就算在低端机子上也可以满足要求。毕竟Flex是缓存了好多资源在客户端。

对于终端这种系统既要求客户体验，也要求性能，又要求更新方便等。其实Flex才是最适合的，纵观各大商城的终端其实大多数都是Flex，用Web App的真是很少数。而用客户端的形式可能已经淹没在大潮之下了。

用Web App也不是不可以，比如Single Page App就可以做到，只是我们部门这块经验根本就没有，就算我想弄也没机会，更别说是那个有决定权的部门了。而将浏览器上的Web App做法搬到终端机上，性能问题就一下子蜂拥而来了。

从客户的反馈：

1. 终端系统就是慢，点哪里都慢
2. 白屏，慢还能接受，但是经常白屏

而之所以弄那么久还没弄好，归根到底是各方面因素累积起来造成的：

1. 原来负责设计最清楚这个系统的初始决策的人已经拍拍屁股走了，所以后来的人很多都要看代码才能知道是怎么回事
2. 整个项目代码混乱得没人想看，事情又多，开发基本都是全新学习了解这个系统的，加上混乱得一塌糊涂，开发很抵触
3. 页面Ajax滥用
4. 浏览器版本过低性能低
5. 终端机性能太差
6. 页面跳转是整个页面切换，不是真的局部刷新
7. 其他厂商的硬件相关代码存在性能问题
8. 后台Web系统响应不快
9. 页面请求资源过多，好多JS文件

部门之前一直在压力测试后台，但在我看来根本原因都是前台造成的，毕竟我们系统交互是通过内网的，后台系统都部署在高端刀片机上，再烂的代码在你机子上响应的速度和在终端机上响应的速度不至于差距那么大。

先后采取了一些这样的因素：

1. 减少首页的Ajax请求为直接页面渲染
2. JS/CSS放到恰当的位置

但是这些做法只应用在个别的几个页面上，所以客户反馈是没变化。

因为我一直都没参与这件事情，毕竟这个火坑水深得很。

我当初就觉得，选型就错了，要想根治，只有领导有魄力直接推翻返回去Flex才是最好的解决方式，毕竟Web如果只是应付几个简单页面倒没啥问题，应付这种复杂业务要在终端上达到性能不错的程度对我们部门的开发人员要求太高了，现在是不大可能的，没人力，没时间。

之前有位老员工也给经理这样的答复，给他一个月时间返回去用Flex，也就是改下页面而已，他可以弄完。但是呢，经理却觉得上层领导不同意，因为这是倒退，从HTML5倒退到Flex，My God，技术就只有适合不适合之分，这个新终端对于原来的Flex终端才是倒退呢。这新终端就算改造成Single Page App，带来的代价也是好大，而且是没经过验证的，而Flex是经历过验证的。这两个代价可以说是类似的，但是谁稳妥基本是显然易见的。

最近我也被折腾到里面去看前端性能。

因为在终端机上看到的前端资源下载流水线实在是太寒碜了。

<img src="http://i.stack.imgur.com/BHfYq.jpg"/>

上面只是我本机的截图，我用的Firefox版本是4.0.1，可以看到在资源过多的情况下资源下载的时间都100多ms左右，加上解析整个时间可能就用到1s多以上，而这是我本机，CPU双核2G，内存3G的情况下，在终端机上的时间基本都是5s左右，下载资源解析都2~3s了，而且更可怕的是我们还好多Ajax请求刷新里面内容，造成的DOM重新渲染几率太多了。理论上浏览器应该不会重新渲染整个页面，但是呢，在这种乱七八糟完全不懂前端的人的手下还真有可能的。

开始的时候我一度怀疑浏览器的缓存是不是失效了，这些资源在请求之后不会再向服务器发起请求的呀，折腾了好久的缓存策略之后，后来我还发问题问过FireBug的维护人员，其实上面的截图细心的话会发现其实是灰色的，在老版本的情况下是代表从浏览器缓存取的，并没有发起请求从服务器上取，So，在这个低端的浏览器上，资源并发读取缓存过多的时候时间都在几百ms的话，可能在Web浏览器上真的不是什么问题，可以容忍的，但是在终端机上带来的问题实在是太大了。

毕竟，我们的系统是切换页面的，响应慢一点带来可能的白屏也就大一点。

所以整个前端归根到底问题主要在两个方面：

1. 浏览器性能太差
2. 页面切换时候是刷新页面

对比起终端机上那低端的性能，想升级浏览器来期盼加快速度，真的不一定就是好，因为Firefox占资源不少，终端机实在是内存太少了。

将页面切换成Single Page App估计才是最有效的方式，而这个对原来代码的推翻实在是太大了，在没验证过的情况下，实在是很大的风险。

所以，Flex吧。






